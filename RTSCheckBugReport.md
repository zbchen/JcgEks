# Replication and Fixes for the Bugs in RTSCheck

We provide a replication step to illustrate the bugs in RTSCheck on JDK11 Ubuntu20.04:

* Generated a program that failed to compile.

* The test classes are not recompiled.

We provided one of the generated programs, in which only the applications classes can be compiled but the test classes fail to be compiled. The program is located in the following directory in the package (RTSCheckBugReport).

```
./rtscheck/autoep/generated_programs/renamemethod-remove-extends/program0/test14-1/1
```

We can use the following command to confirm that the program cannot be compiled:

```
cd rtscheck/autoep/generated_programs/renamemethod-remove-extends/program0/test14-1/1
mvn clean test
```

However, this program can be executed within the RTSCheck framework and cannot detect compilation failures. We use the following command to run RTSCheck (only run TestAll):

```
cd rtscheck/autoep/
python3 run_autoep.py --run
cat _results/renamemethod-remove-extends/test14-1/1/notool.log
```

We can see that the log successfully outputs the number of test cases executed, but the program actually cannot pass compilation.

```
test1(Package_0.TestGroup4CaseTest15)  Time elapsed: 0 sec  <<< ERROR!
java.lang.NoSuchMethodError: Package_1.ClassId_1.m_0()J
	at Package_0.TestGroup4CaseTest15.test1(TestGroup4CaseTest15.java:19)
......	

Tests in error: 
  TestGroup4CaseTest0.test1:20 NoSuchMethod Package_1.ClassId_1.m_0()J
  TestGroup4CaseTest10.test1:20 NoSuchMethod Package_1.ClassId_1.m_0()J
  TestGroup4CaseTest12.test1:19 NoSuchMethod Package_1.ClassId_1.m_0()J
......

Tests run: 32, Failures: 0, Errors: 23, Skipped: 0

[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
```

The defect of the first bug is in the `compileAllPrograms` function of the `run_autoep.py` which only compiles the application program by `mvn compile` without compiling the test classes. The correct command should be `mvn compile test-compile`:

```
def compileAllPrograms(root_list):
    ''' Compile all the programs generated by jdolly, return the list of all the compilable 
    programs.
    '''            
    valid_root_list = []
    cwd = os.getcwd()
    for root in root_list:
        os.chdir(root + '/0')
        # Log compilation at the same time
        sp = sub.run('mvn compile', shell=True, stdout=open(os.devnull, 'w'), stderr=sub.STDOUT)
```

The following shows one case of the second bug's defect in `run_autoep.py`, in which only `mvn test` is used and the test classes are not re-compiled, which may result in inconsistency between source code and bytecode. We can use  `mvn clean test` to fix this bug by recompiling all the source files.

```
    if tool == 'notool':
        # V0 start
        ......
        # V1 start
        os.chdir(v0_prog_dir)
        shutil.rmtree(v0_prog_dir + '/src/main')
        sub.run('cp -r ' + v1_prog_dir + '/src/main' + ' ' + v0_prog_dir + '/src', shell=True)
        start_time = int(round(time.time() * 1000))
        print ('[AutoEP]: Running RetestAll on V1')
        cmd = 'mvn test -fn -l' + v1_logs_dir + '/notool.log'
        sub.run(cmd, shell=True, \
                stdout=open(v1_logs_dir + '/notool.log', 'w'), stderr=sub.STDOUT)
```

We have fix these two bugs and provided a new `run_autoep_fix.py` in `rtscheck/autoep/`. Using this script, we can find compilation errors during benchmark generation. Besides, if the generated benchmark can be compiled, the script will recompile all the sources (including the test class sources) when testing a RTS tool.
